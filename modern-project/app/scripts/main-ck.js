"use strict";var ProductApp=new Backbone.Marionette.Application,productsCollection={},Router={},EventListener={};_.extend(EventListener,Backbone.Events);ProductApp.addRegions({productListRegion:"#view",exportRegion:"#viewExported"});ProductApp.ProductsModel=Backbone.Model.extend({defaults:{title:"",sku:"",price:""}});ProductApp.ProductsRouter=Backbone.Router.extend({routes:{home:"home",add:"add","edit/:sku":"edit"},home:function(){ProductApp.productListRegion.show(new ProductApp.AppLayoutView)},add:function(){this.loadView(new ProductApp.AddProductFormView({collection:productsCollection}))},edit:function(e){this.loadView(new ProductApp.EditProductFormView({collection:productsCollection,model:productsCollection.where({sku:e})[0]}))},loadView:function(e){this.view&&(this.view.close?this.view.close():this.view.remove());this.view=e}});ProductApp.ProductsCollection=Backbone.Collection.extend({model:ProductApp.ProductsModel,comparator:"authorLast",url:"scripts/fake/data.json"});ProductApp.EditProductFormView=Marionette.ItemView.extend({template:_.template($("#product-edit-item").html()),events:{"click .btn.edit-product":"onEditProduct","click .btn.cancel-edit":"onCancel"},initialize:function(){$("#view").html(this.el);this.render()},render:function(){this.$el.html(this.template(this.options.model.attributes));return this},onEditProduct:function(e){var t=JSON.stringify(this.$el.find("form").serializeArray()),n={};$.each($.parseJSON(t),function(e,t){if(n[this.name]){n[this.name].push||(n[this.name]=[n[this.name]]);n[this.name].push(this.value||"")}else n[this.name]=this.value||""});var r=this.options.model.set(n);Router.navigate("home",{trigger:!0,replace:!0})},onCancel:function(e){Router.navigate("home",{trigger:!0,replace:!0})}});ProductApp.AddProductFormView=Marionette.ItemView.extend({template:_.template($("#product-add-item").html()),events:{"click .btn.add-product":"onCreateProduct","click .btn.cancel-add":"onCancel"},initialize:function(){$("#view").html(this.el);this.render()},onCreateProduct:function(e){var t=JSON.stringify(this.$el.find("form").serializeArray()),n={};$.each($.parseJSON(t),function(e,t){if(n[this.name]){n[this.name].push||(n[this.name]=[n[this.name]]);n[this.name].push(this.value||"")}else n[this.name]=this.value||""});var r=new ProductApp.ProductsModel(n);this.collection.add(r);Router.navigate("home",{trigger:!0,replace:!0})},onCancel:function(e){Router.navigate("home",{trigger:!0,replace:!0})}});ProductApp.AddProductsItemView=Marionette.ItemView.extend({el:"#add-button-bar",events:{"click .btn.show-add-product":"onAddProduct","click .btn.show-export-json":"onExport"},onAddProduct:function(e){Router.navigate("add",{trigger:!0,replace:!0})},onExport:function(e){EventListener.trigger("onexport")}});ProductApp.ExportProductss=Marionette.ItemView.extend({el:"#viewExported",initialize:function(){EventListener.bind("onexport",this.onExportHandler,this)},onExportHandler:function(e){console.log("Export part triggered",this.collection.toJSON());this.$el.empty().append($.parseHTML("<b>Parsed</b><br/>")).append(JSON.stringify(this.collection.toJSON()))}});ProductApp.ProductsItemView=Marionette.ItemView.extend({tagName:"tr",template:_.template($("#product-list-template").html()),events:{"click .edit-product":"onEditProductClick","click .remove-product":"onRemoveProductClick"},onEditProductClick:function(e){Router.navigate("edit/"+this.model.get("sku"),{trigger:!0,replace:!0})},onRemoveProductClick:function(e){console.log("remove",e);this.model.destroy()},initialize:function(){this.model.on("change",this.render,this);this.model.on("destroy",this.remove,this)},remove:function(){this.$el.remove()},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});ProductApp.ProductsCollectionView=Marionette.CollectionView.extend({tagName:"tbody",id:"collection-body",childView:ProductApp.ProductsItemView,onShow:function(){console.log("ProductsCollectionView on Show");$("#collection-body").contents().unwrap()}});ProductApp.AppLayoutView=Backbone.Marionette.LayoutView.extend({tagName:"table",id:"products-table",className:"table",template:"#product-list-body-template",regions:{RegionOne:"#products-table-body"},initialize:function(){console.log("main layout: initialize")},onRender:function(){console.log("main layout: onRender")},showProductsCollectionView:function(e){var t=new ProductApp.ProductsCollectionView({collection:productsCollection});e.RegionOne.show(t)},onShow:function(){console.log("main layout: onShow");var e=this;if(!productsCollection.models){productsCollection=new ProductApp.ProductsCollection;productsCollection.fetch({success:function(t){var n=_.clone(productsCollection.models[0].attributes.products);productsCollection=new ProductApp.ProductsCollection(n);var r=new ProductApp.AddProductsItemView({collection:productsCollection}),i=new ProductApp.ExportProductss({collection:productsCollection});e.showProductsCollectionView(e)}})}else this.showProductsCollectionView(this)}});ProductApp.addInitializer(function(){Router=new ProductApp.ProductsRouter;var e=new ProductApp.AppLayoutView;Backbone.history.start();ProductApp.productListRegion.show(e)});$(document).ready(function(){ProductApp.start()});